<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head') %>
<style>
    
.kth-alert {
    position: relative;       /* F√∂r att absolut-positionera knappen */
}
.kth-icon-button.close {
    position: absolute;       /* Placera knappen ovanp√• alerten */
    top: 0.25rem;
    right: 0.25rem;
    cursor: pointer;
}
.record-cell {
  min-width: 250px;
 word-wrap: break-word;   /* Bryt l√•nga ord */
}

.record-preview {
  white-space: pre-wrap;   /* Beh√•ll radbrytningar */
  word-break: break-all; /* Bryt l√•nga ord */
  overflow: hidden;
}

.record-full {
  white-space: pre-wrap;
  word-wrap: break-word;
  word-break: break-all; /* Bryt l√•nga ord */
  margin-top: 0.5rem;
}
.d-none {
  display: none !important;
}

table td {
    font-size: 12px;
}

table td, table th {
    white-space: normal;       /* till√•t radbrytning */
    word-break: normal;        /* bryt inte mitt i ord */
    overflow-wrap: break-word; /* bryt vid mellanslag om raden blir f√∂r l√•ng */
    padding: .35rem .5rem;
    border: 1px solid #ddd;
    vertical-align: top;
}

/* Lite enklare table styling s√• det ser okej ut */
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto; 
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.table-responsive table {
  width: 100%;
  border-collapse: collapse;
}

.json-scroll {
    max-height: 200px;   /* begr√§nsad h√∂jd */
    overflow: auto;      /* scroll n√§r inneh√•llet √§r st√∂rre */
    white-space: pre;    /* beh√•ller radbrytningar */
    font-family: monospace;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
}

.json-scroll pre {
    white-space: normal;

.marc-table {
  border-collapse: collapse;
  width: 100%;
  font-family: monospace;
  font-size: 0.9em;
}
.marc-table th, .marc-table td {
  border: 1px solid #ccc;
  padding: 2px 6px;
  text-align: left;
  vertical-align: top;
}
.marc-table th {
  background-color: #f2f2f2;
}
</style>
    <body>
        <%- include('../partials/header') %>

            <div class="kth-main-content">

                <h1>Importerade Libris-poster</h1>
                <div id="alertPlaceholder"></div>
                <div class="table-responsive"></div>
                    <table border="1" cellpadding="5">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>LibrisId</th>
                                <th>Typ</th>
                                <th>Record</th>
                                <th>RecordMarc</th>
                                <th>Meddelande</th>
                                <th>Omf√∂rs√∂k</th>
                                <th>Mail om fel skickat</th>
                                <th>Tidpunkt</th>
                                <th>Status</th>
                                <th>√Ötg√§rd</th>
                            </tr>
                        </thead>
                    <tbody id="recordsBody">
                            <% records.forEach(r=> { %>
                                <tr>
                                    <td>
                                        <%= r.id %>
                                    </td>
                                    <td>
                                        <%= r.libris_id %>
                                    </td>
                                    <td>
                                        <%= r.record_type %>
                                    </td>
                                    
                                    <td class="record-cell">
                                        <div class="record-full json-scroll"><pre><%= r.record %></pre></div>
                                    </td>
                                    <td class="record-cell">
                                        <div class="record-full json-scroll"><% if (r.marcTable && r.marcTable.length > 0) { %><table class="marc-table" border="1" cellpadding="3">
                                                <thead>
                                                <tr>
                                                    <th>Tag</th>
                                                    <th>I1</th>
                                                    <th>I2</th>
                                                    <th>Subfield data</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <% r.marcTable.forEach(row => { %>
                                                    <tr>
                                                    <td><%= row.tag %></td>
                                                    <td><%= row.i1 %></td>
                                                    <td><%= row.i2 %></td>
                                                    <td><%= row.data %></td>
                                                    </tr>
                                                <% }) %>
                                                </tbody>
                                            </table>
                                            <% } else { %>
                                            <em>Inget MARC-data</em>
                                            <% } %>
                                        </div>
                                    </td>
                                    <td>
                                        <%= r.message %>
                                    </td>
                                    <td>
                                        <%= r.attempts %>
                                    </td>
                                    <td>
                                        <%= r.mail_sent ? '‚úÖ' : '‚ùå' %>
                                    </td>
                                    <td>
                                        <%= new Date(r.last_attempt).toLocaleString('sv-SE') %>
                                    </td>
                                    <td>
                                        <%= r.status=='success' ? '‚úÖ' : '‚ùå'; %>
                                    </td>
                                    <td>
                                        <% if (r.attempts >= 5 && r.status === 'max_attempts') { %>
                                            <button class="retry-btn" data-id="<%= r.id %>">üîÑ</button>
                                        <% } %>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
    </body>
    <script>
        /** Konfig */
        const REFRESH_MS = <%- JSON.stringify(refreshMs) %>;
        /** Hj√§lp: escape f√∂r text innan vi s√§tter innerHTML */
        function escapeHtml(str = '') {
            return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function alertMessage(message, type, placeholder, remove=true, removaltime=5000 ) {
            var alertPlaceholder = document.getElementById(placeholder)
            var wrapper = document.createElement('div')
            wrapper.innerHTML = 
            '<div class="kth-alert ' + type + ' alert-dismissible fade show" role="alert">' 
                + message + 
                '<button class="kth-icon-button close"><span class="kth-visually-hidden">{"close"}</span></button>' + 
            '</div>'
            alertPlaceholder.append(wrapper)
            const closeBtn = wrapper.querySelector('.kth-icon-button.close');
            const alertDiv = wrapper.querySelector('.kth-alert');

            closeBtn.addEventListener('click', () => {
                $(alertDiv).fadeTo(500, 0).slideUp(500, function () {
                    $(alertDiv).parent().remove();
                });
            });
            if(remove) {
                setTimeout(function () {
                    $(alertDiv).fadeTo(500, 0).slideUp(500, function(){
                        $(alertDiv).remove(); 
                    });
                }, removaltime);
            }
        }

        /** Ladda poster fr√•n server (f√∂rv√§ntar JSON-array fr√•n /failedlibrisrecords/json) */
        async function loadRecords() {
            try {
                url = '/almatools/failedlibrisrecords/json';
                const res = await fetch(url, { cache: 'no-cache' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();

                const table = document.querySelector('table');
                if (!table) return;

                // Se till att tbody finns
                let tbody = table.querySelector('tbody');
                if (!tbody) {
                    tbody = document.createElement('tbody');
                    tbody.id = 'recordsBody';
                    table.appendChild(tbody);
                }

                // t√∂m tbody
                tbody.innerHTML = '';

                // fyll med rader (escapeHtml)
                data.forEach(r => {
                    const id = escapeHtml(r.id);
                    const librisId = escapeHtml(r.libris_id);
                    const recordType = escapeHtml(r.record_type);
                    const attempts = escapeHtml(r.attempts);
                    const mailSent = r.mail_sent ? '‚úÖ' : '‚ùå';
                    const lastAttempt = escapeHtml(new Date(r.last_attempt).toLocaleString('sv-SE') || '');
                    const status = r.status=='success' ? '‚úÖ' : '‚ùå';
                    const message = escapeHtml(r.message || '');
                    const recordPreview = escapeHtml((r.record || '').substring(0,200));
                    const recordFull = escapeHtml(r.record || '');
                    const recordMarc = escapeHtml(r.marcTable || '');

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${id}</td>
                        <td>${librisId}</td>
                        <td>${recordType}</td>
                        <td class="record-cell">
                            <div class="record-full json-scroll"><pre>${recordFull}</pre></div>
                        </td>
                        <td class="record-cell">
                            <div class="record-full json-scroll"><table class="marc-table" border="1" cellpadding="3">
                                    <thead>
                                    <tr>
                                        <th>Tag</th>
                                        <th>I1</th>
                                        <th>I2</th>
                                        <th>Subfield data</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        ${r.marcTable.map(row => `
                                            <tr>
                                                <td>${row.tag}</td>
                                                <td>${row.i1}</td>
                                                <td>${row.i2}</td>
                                                <td>${row.data}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                        <td>${message}</td>
                        <td>${attempts}</td>
                        <td>${mailSent}</td>
                        <td>${lastAttempt}</td>
                        <td>${status}</td>
                        <td>${Number(attempts) >= 5 && r.status === 'max_attempts' ? `<button class="retry-btn" data-id="${id}">üîÑ</button>` : ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                console.error('Fel vid laddning av poster:', err);
                alertMessage('Kunde inte ladda poster: ' + (err.message || err), 'warning', 'alertPlaceholder', false);
            }
        }

        /** Delegated event handling (sitter kvar oavsett om tbody byts ut) */
        function bindDelegatedHandlers() {
            const table = document.querySelector('table');
            if (!table) return;

            // Delegation p√• tbody (skapar listener en g√•ng)
            table.addEventListener('click', async (e) => {
                // Retry-knapp
                const retryBtn = e.target.closest('.retry-btn');
                if (retryBtn) {
                    const id = retryBtn.dataset.id;
                    // disable knapp medan request p√•g√•r
                    retryBtn.disabled = true;
                    try {
                        const res = await fetch(`retrylibrisimport/${encodeURIComponent(id)}`, { method: 'POST' });
                        const data = await res.json();

                        if (data && data.success) {
                            alertMessage(data.message || 'Omf√∂rs√∂k triggat', 'success', 'alertPlaceholder', true);
                        } else {
                            alertMessage((data && data.message) || 'Omf√∂rs√∂k misslyckades', 'warning', 'alertPlaceholder', false);
                        }
                    } catch (err) {
                        alertMessage('Tekniskt fel vid omf√∂rs√∂k: ' + (err.message || err), 'warning', 'alertPlaceholder', false);
                    } finally {
                        retryBtn.disabled = false;
                        // Ladda om listan efter f√∂rs√∂ket
                        loadRecords();
                    }
                    return;
                }
            });
        }
        /** Init n√§r DOM √§r redo */
        document.addEventListener('DOMContentLoaded', () => {
            bindDelegatedHandlers();
            setInterval(loadRecords, REFRESH_MS);
        });
    </script>

</html>