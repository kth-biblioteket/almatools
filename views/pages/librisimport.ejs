<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head') %>
<style>
    
.kth-alert {
    position: relative;       /* F√∂r att absolut-positionera knappen */
}
.kth-icon-button.close {
    position: absolute;       /* Placera knappen ovanp√• alerten */
    top: 0.25rem;
    right: 0.25rem;
    cursor: pointer;
}
.record-cell {
  min-width: 250px;
 word-wrap: break-word;   /* Bryt l√•nga ord */
}

.record-preview {
  white-space: pre-wrap;   /* Beh√•ll radbrytningar */
  word-break: break-all; /* Bryt l√•nga ord */
  overflow: hidden;
}

.record-full {
  white-space: pre-wrap;
  word-wrap: break-word;
  word-break: break-all; /* Bryt l√•nga ord */
  margin-top: 0.5rem;
}
.d-none {
  display: none !important;
}

table td {
    font-size: 12px;
}

table td, table th {
    white-space: normal;       /* till√•t radbrytning */
    word-break: normal;        /* bryt inte mitt i ord */
    overflow-wrap: break-word; /* bryt vid mellanslag om raden blir f√∂r l√•ng */
    padding: .35rem .5rem;
    border: 1px solid #ddd;
    vertical-align: top;
}

/* Lite enklare table styling s√• det ser okej ut */
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto; 
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.table-responsive table {
  width: 100%;
  border-collapse: collapse;
}

.json-scroll {
    max-height: 200px;   /* begr√§nsad h√∂jd */
    overflow: auto;      /* scroll n√§r inneh√•llet √§r st√∂rre */
    white-space: pre;    /* beh√•ller radbrytningar */
    font-family: monospace;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
}

.json-scroll pre {
    white-space: normal;
}

.marc-table {
  border-collapse: collapse;
  width: 100%;
  font-family: monospace;
  font-size: 0.9em;
  table-layout: fixed;
}
.marc-table th, .marc-table td {
  border: 1px solid #ccc;
  padding: 2px 6px;
  text-align: left;
  vertical-align: top;
  word-break: break-word; /* Bryt l√•nga ord */
  white-space: normal; /* Till√•t radbrytning */
}
.marc-table th {
  background-color: #f2f2f2;
}
</style>
    <body>
        <%- include('../partials/header') %>

            <div class="kth-main-content">

                <h1>Importerade Libris-poster</h1>
                <div id="alertPlaceholder"></div>
                <div class="filter-controls" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
        
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter" class="form-control">
                        <option value="all">Alla</option>
                        <option value="failed" selected>Misslyckade (‚ùå)</option>
                        <option value="success">Lyckade (‚úÖ)</option>
                        <option value="max_attempts">Max Omfr√∂rs√∂k</option>
                    </select>

                    <label for="sortFilter">Sortera:</label>
                    <select id="sortFilter" class="form-control">
                        <option value="last_attempt_desc">Senaste (Tidpunkt ‚Üì)</option>
                        <option value="last_attempt_asc">√Ñldsta (Tidpunkt ‚Üë)</option>
                        <option value="attempts_desc">Flest Omf√∂rs√∂k</option>
                        <option value="attempts_asc">F√§rst Omf√∂rs√∂k</option>
                    </select>

                    <button id="applyFiltersBtn" class="kth-btn">Uppdatera</button>

                    <label style="margin-left: 1rem;">
                        <input type="checkbox" id="autoRefreshCheckbox"> Automatisk uppdatering
                    </label>

                    <span id="loadingIndicator" style="display: none;"> Laddar... </span>
                </div>
                <div class="table-responsive">
                    <table border="1" cellpadding="5">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>LibrisId</th>
                                <th>Typ</th>
                                <th>RecordMarc</th>
                                <th>Meddelande</th>
                                <th>Omf√∂rs√∂k</th>
                                <th>Mail om fel skickat</th>
                                <th>Tidpunkt</th>
                                <th>Status</th>
                                <th>√Ötg√§rd</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                        </tbody>
                    </table>
                </div>
            </div>
    </body>
    <script>
        const REFRESH_MS = <%- JSON.stringify(refreshMs) %>;
        let refreshIntervalId = null;

        function escapeHtml(str = '') {
            return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function alertMessage(message, type, placeholder, remove=true, removaltime=5000 ) {
            var alertPlaceholder = document.getElementById(placeholder)
            var wrapper = document.createElement('div')
            wrapper.innerHTML = 
            '<div class="kth-alert ' + type + ' alert-dismissible fade show" role="alert">' 
                + message + 
                '<button class="kth-icon-button close"><span class="kth-visually-hidden">{"close"}</span></button>' + 
            '</div>'
            alertPlaceholder.append(wrapper)
            const closeBtn = wrapper.querySelector('.kth-icon-button.close');
            const alertDiv = wrapper.querySelector('.kth-alert');

            closeBtn.addEventListener('click', () => {
                $(alertDiv).fadeTo(500, 0).slideUp(500, function () {
                    $(alertDiv).parent().remove();
                });
            });
            if(remove) {
                setTimeout(function () {
                    $(alertDiv).fadeTo(500, 0).slideUp(500, function(){
                        $(alertDiv).remove(); 
                    });
                }, removaltime);
            }
        }

        function startAutoRefresh() {
            if (refreshIntervalId === null) {
                refreshIntervalId = setInterval(() => loadRecords(false), REFRESH_MS);
            }
        }

        function stopAutoRefresh() {
            if (refreshIntervalId !== null) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }

        async function loadRecords(showLoading = true) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            if (showLoading) {
                loadingIndicator.style.display = 'inline';
            }
            
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            try {

                const params = new URLSearchParams();
                if (statusFilter !== 'all') {
                    params.append('status', statusFilter);
                }
                if (sortFilter) {
                    params.append('sort', sortFilter);
                }

                const url = `/almatools/failedlibrisrecords/json?${params.toString()}`;
                
                const res = await fetch(url, { cache: 'no-cache' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                
                const table = document.querySelector('table');
                if (!table) return;

                let tbody = table.querySelector('tbody');
                if (!tbody) {
                    tbody = document.createElement('tbody');
                    tbody.id = 'recordsBody';
                    table.appendChild(tbody);
                }

                tbody.innerHTML = '';

                data.forEach(r => {
                    const id = escapeHtml(r.id);
                    const librisId = escapeHtml(r.libris_id);
                    const recordType = escapeHtml(r.record_type);
                    const attempts = escapeHtml(r.attempts);
                    const mailSent = r.mail_sent ? '‚úÖ' : '‚ùå';
                    const lastAttempt = escapeHtml(new Date(r.last_attempt).toLocaleString('sv-SE') || '');
                    const status = r.status=='success' ? '‚úÖ' : '‚ùå';
                    const message = escapeHtml(r.message || '');
                    const recordPreview = escapeHtml((r.record || '').substring(0,200));
                    const recordFull = escapeHtml(r.record || '');
                    const recordMarc = escapeHtml(r.marcTable || '');
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td>${escapeHtml(r.id)}</td>
                        <td>${escapeHtml(r.libris_id)}</td>
                        <td>${escapeHtml(r.record_type)}</td>
                        <td class="record-cell">
                            <div class="record-full json-scroll"><table class="marc-table" border="1" cellpadding="3">
                                    <colgroup>
                                        <col style="width: 10%">
                                        <col style="width: 8%">
                                        <col style="width: 8%">
                                        <col style="width: 74%">
                                    </colgroup>
                                    <thead>
                                    <tr>
                                        <th>Tag</th>
                                        <th>I1</th>
                                        <th>I2</th>
                                        <th>Subfield data</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        ${r.marcTable.map(row => `
                                            <tr>
                                                <td>${row.tag}</td>
                                                <td>${row.i1}</td>
                                                <td>${row.i2}</td>
                                                <td>${row.data}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                        <td>${message}</td>
                        <td>${attempts}</td>
                        <td>${mailSent}</td>
                        <td>${lastAttempt}</td>
                        <td>${status}</td>
                        <td>${Number(attempts) >= 5 && r.status === 'max_attempts' ? `<button class="retry-btn" data-id="${id}">üîÑ</button>` : ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                console.error('Fel vid laddning av poster:', err);
                alertMessage('Kunde inte ladda poster: ' + (err.message || err), 'warning', 'alertPlaceholder', false);
            } finally {
                if (showLoading) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        function bindDelegatedHandlers() {
            
            const table = document.querySelector('table');
            if (!table) return;

            // Delegation p√• tbody (skapar listener en g√•ng)
            table.addEventListener('click', async (e) => {
                const retryBtn = e.target.closest('.retry-btn');
                if (retryBtn) {
                    const id = retryBtn.dataset.id;
                    // disable knapp medan request p√•g√•r
                    retryBtn.disabled = true;
                    try {
                        const res = await fetch(`retrylibrisimport/${encodeURIComponent(id)}`, { method: 'POST' });
                        const data = await res.json();

                        if (data && data.success) {
                            alertMessage(data.message || 'Omf√∂rs√∂k triggat', 'success', 'alertPlaceholder', true);
                        } else {
                            alertMessage((data && data.message) || 'Omf√∂rs√∂k misslyckades', 'warning', 'alertPlaceholder', false);
                        }
                    } catch (err) {
                        alertMessage('Tekniskt fel vid omf√∂rs√∂k: ' + (err.message || err), 'warning', 'alertPlaceholder', false);
                    } finally {
                        retryBtn.disabled = false;
                        // Ladda om listan efter f√∂rs√∂ket
                        loadRecords(false);
                    }
                    return;
                }
            });

            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                    loadRecords();
                });
            }

            const autoRefreshCheckbox = document.getElementById('autoRefreshCheckbox');
            if (autoRefreshCheckbox) {
                autoRefreshCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindDelegatedHandlers();
            
            loadRecords(false);

            const autoRefreshCheckbox = document.getElementById('autoRefreshCheckbox');
            if (autoRefreshCheckbox && autoRefreshCheckbox.checked) {
                startAutoRefresh();
            }
        });
    </script>

</html>